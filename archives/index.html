<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<title>
  
    归档
  
</title>

<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/archives/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">


  <link rel="alternative" href="/atom.xml" title="Hexo" type="application/atom+xml">



  <link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="/perfect-scrollbar/css/perfect-scrollbar.min.css">
<link rel="stylesheet" href="/styles/main.css">






</head>
<body
  
    class="monochrome"
  
  >
  <div class="mobile-header">
  <button class="sidebar-toggle" type="button">
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
    <span class="icon-bar"></span>
  </button>
  <a class="title" href="/">Hexo</a>
</div>

  <div class="main-container">
    <div class="sidebar">
  <div class="header">
    <h1 class="title"><a href="/">Hexo</a></h1>
    
    <div class="info">
      <div class="content">
        
      </div>
      
        <div class="avatar">
          
            <a href="/about"><img src="https://s12.postimg.org/da8bo4e1p/wyatt.jpg"></a>
          
        </div>
      
    </div>
  </div>
  <div class="body">
    
      
        <ul class="nav">
          
            
              <li class="category-list-container">
                <a href="javascript:;">分类</a>
                
              </li>
            
          
            
              <li class="tag-list-container">
                <a href="javascript:;">标签</a>
                
              </li>
            
          
            
              <li class="archive-list-container">
                <a href="javascript:;">归档</a>
                <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">2016</a><span class="archive-list-count">1</span></li></ul>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="/" title="Homepage">Homepage</a>
              </li>
            
          
            
              <li>
                <a href="/archives" title="By Year">By Year</a>
              </li>
            
          
        </ul>
      
        <ul class="nav">
          
            
              <li>
                <a href="https://github.com/wyattlindsey" title="Github" target="_blank" rel="external">Github</a>
              </li>
            
          
        </ul>
      
    
  </div>
</div>

    <div class="main-content">
      
        <div style="max-width: 1000px">
      
          

  
  
    
      
      
      <section class="archives-wrap">
        <div class="archive-year-wrap">
          <h1><a href="/archives/2016" class="archive-year">2016</a></h1>
        </div>
        <div class="post-list">
    
  

    <div class="post-list-item article">
      <h3 class="article-header">
        <a href="/2016/11/19/ES6-arrow-functions-and-lexical-this/" >
  
</a>

      </h3>
      

      <div class="article-info">
        <a href="/2016/11/19/ES6-arrow-functions-and-lexical-this/"><span class="article-date">
  2016-11-19
</span>
</a>
        

        

      </div>
      <div class="article-entry">
        
          <h1 id="ES6-arrow-functions-and-lexical-this"><a href="#ES6-arrow-functions-and-lexical-this" class="headerlink" title="ES6 arrow functions and lexical this"></a><strong>ES6 arrow functions and lexical <code>this</code></strong></h1><p>Let’s take a look at one of the quirkiest behaviors in JavaScript.  We’ll start by examining the legacy version of the language’s interpretation of the keyword <code>this</code>.  Then we’ll consider some new behavior introduced by ES6’s arrow functions.  How are they different?  Which approach is more intuitive and/or useful?  Read on for insight!</p>
<p>Prior to ECMAScript 2015 (a.k.a. ES6), JavaScript used an uncommon approach to the evaluation of <code>this</code>.  It made object-orientation in a functional language difficult.  For object-oriented design, <code>this</code> serves a critical purpose in creating objects that display polymorphism.  The ECMAScript 5.1 specification interprets so-called <em>ThisBinding</em> in a manner often described as confusing and unintuitive.</p>
<p><em>ThisBinding</em> is one of several execution contexts employed by the JavaScript interpreter to bind values to symbols.  When passing functions as callbacks to other functions, the value of <code>this</code> at runtime might surprise you.  For example:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Cupcake</span>(<span class="params">type, frosting</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.type = type;</div><div class="line">  <span class="keyword">this</span>.frosting = frosting;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.announce = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'And now, the moment you\'ve been waiting for! Presenting...'</span>);</div><div class="line"></div><div class="line">    setTimeout(<span class="keyword">this</span>._present, <span class="number">1500</span>);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>._present = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'...a '</span> + <span class="keyword">this</span>.type +</div><div class="line">      <span class="string">' cupcake with '</span> + <span class="keyword">this</span>.frosting + <span class="string">' frosting'</span>);</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> chocolateCupcake = <span class="keyword">new</span> Cupcake(<span class="string">'chocolate'</span>, <span class="string">'buttercream'</span>);</div><div class="line">chocolateCupcake.announce();</div></pre></td></tr></table></figure>
<p>Everything looks like it should work.  The <code>announce()</code> method is going to queue up some code for 1.5 seconds in the future.  The function it passes to <code>setTimeout</code> refers to some information about the cupcake.  These attributes are stored in that instance of the Cupcake object.  The helper function <code>_present()</code> is defined in the same scope as the member variables <code>this.type</code> and <code>this.frosting</code>.  So why do we get the following output?</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">And now, the moment you've been waiting for! Presenting...</div><div class="line">...a undefined cupcake with undefined frosting</div></pre></td></tr></table></figure>
<p>The problem is that when <code>present()</code> eventually goes off, the value of <code>this</code> is not this cupcake instance, even though <em>it really looks like it should be.</em>  After all, we’re defining <code>_present()</code> in the same block of code where we set the variables <code>this.type</code> and <code>this.frosting</code>.  In truth the value of <code>this</code> is decided later on, in the current execution context in which it was invoked.  In the case of <code>_present()</code>, when it’s invoked 1.5 seconds later, we’re actually in the global scope.  In that case, <code>this</code> refers to the global object <code>window</code>.</p>
<h2 id="Options-for-ThisBinding"><a href="#Options-for-ThisBinding" class="headerlink" title="Options for ThisBinding"></a>Options for ThisBinding</h2><h3 id="closure"><a href="#closure" class="headerlink" title="closure"></a>closure</h3><p>So how can we make the keyword <code>this</code> resolve to the thing we actually want and not <code>window</code>?  To write event-driven, asynchronous code we need our callbacks to know about the context in which they were defined, about the objects involved in the event.  If <code>this</code> were just like any other variable, we wouldn’t have anything to worry about.  In fact, assigning the value of <code>this</code> to a variable and then using <em>that variable</em> inside the callback provides one possible solution.  The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures" target="_blank" rel="external">closure feature</a> of the language, part of lexical scoping, makes this possible:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Cupcake</span>(<span class="params">type, frosting</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.type = type;</div><div class="line">  <span class="keyword">this</span>.frosting = frosting;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.announce = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'And now, the moment you\'ve been waiting for! Presenting...'</span>);</div><div class="line"></div><div class="line">    setTimeout(<span class="keyword">this</span>._present, <span class="number">1500</span>);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>._present = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'...a '</span> + self.type +</div><div class="line">      <span class="string">' cupcake with '</span> + self.frosting + <span class="string">' frosting'</span>);</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> chocolateCupcake = <span class="keyword">new</span> Cupcake(<span class="string">'chocolate'</span>, <span class="string">'buttercream'</span>);</div><div class="line">chocolateCupcake.announce();</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">And now, the moment you've been waiting for! Presenting...</div><div class="line">...a chocolate cupcake with buttercream frosting</div></pre></td></tr></table></figure>
<h3 id="the-bind-method"><a href="#the-bind-method" class="headerlink" title="the bind method"></a>the <code>bind</code> method</h3><p><code>Function.prototype.bind</code> allows us to use a specialized version of the function that bakes in arguments and the <code>this</code> binding.  When it’s invoked, the arguments are passed into the function as per usual.  Also, the function is called as if it were invoked in the same context as the scope in which it was defined before being passed as a callback.  Here’s an example of <code>bind</code> in action:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">  this.announce = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'And now, the moment you\'ve been waiting for! Presenting...'</span>);</div><div class="line"></div><div class="line">    setTimeout(<span class="keyword">this</span>._present.bind(<span class="keyword">this</span>), <span class="number">1500</span>);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>._present = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'...a '</span> + <span class="keyword">this</span>.type +</div><div class="line">      <span class="string">' cupcake with '</span> + <span class="keyword">this</span>.frosting + <span class="string">' frosting'</span>);</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">And now, the moment you've been waiting for! Presenting...</div><div class="line">...a chocolate cupcake with buttercream frosting</div></pre></td></tr></table></figure>
<h2 id="Enter-ES6-arrow-functions"><a href="#Enter-ES6-arrow-functions" class="headerlink" title="Enter ES6 arrow functions"></a>Enter ES6 arrow functions</h2><p>Since we use anonymous functions so frequently in JavaScript, the new fat arrow functions in the ECMAScript 2015 spec are most welcome.  They afford the following advantages:</p>
<ul>
<li>concise syntax</li>
<li>lexical binding of <code>this</code></li>
<li>several syntactic sugar features</li>
</ul>
<p>Let’s take a look at the first two in action:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">this.announce = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'And now, the moment you\'ve been waiting for! Presenting...'</span>);</div><div class="line"></div><div class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'...a '</span> + <span class="keyword">this</span>.type +</div><div class="line">      <span class="string">' cupcake with '</span> + <span class="keyword">this</span>.frosting + <span class="string">' frosting'</span>);</div><div class="line">  &#125;, <span class="number">1500</span>);</div><div class="line">&#125;;</div><div class="line">...</div></pre></td></tr></table></figure>
<p><code>And now, the moment you&#39;ve been waiting for! Presenting...
...a chocolate cupcake with buttercream frosting</code></p>
<p>Here’s another quick refactor using an arrow function and showing off its implicit return in a concise function body (no curly braces):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.on(<span class="string">'eat'</span>, (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.type + <span class="string">' cupcakes are delicious'</span>;</div><div class="line">&#125;).bind(<span class="keyword">this</span>));</div><div class="line"></div><div class="line"><span class="comment">// this ^^ becomes this:</span></div><div class="line"></div><div class="line"><span class="keyword">this</span>.on(<span class="string">'eat'</span>, () =&gt; (<span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.type&#125;</span> cupcakes are delicious`</span>));</div></pre></td></tr></table></figure>
<p>Arrow functions make it easy to inline anonymous functions in all those places we need them, such as asynchronous callbacks, higher order functions and event handlers.  <code>this</code> works just like most people would expect.  And the best part is, we can still <code>.bind</code>,  <code>.call</code> , <code>apply</code> and otherwise use the old ES5 non-arrow functions to our heart’s content in ES6.  The specification lets you mix and match both styles, so use whichever suits the situation.</p>
<h3 id="caveats"><a href="#caveats" class="headerlink" title="caveats"></a>caveats</h3><p>Some libraries like jQuery and Backbone have their own strategies for  <code>this</code>, which use ES5’s interpretation.  For example, many jQuery callbacks use <code>$(this)</code> to pinpoint the target object out of the DOM.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'#cupcake'</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">  $(<span class="keyword">this</span>).append(<span class="string">'&lt;h1&gt;more HTML&lt;/h1&gt;'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>An arrow function would cause the selector above to fail, since the context isn’t what jQuery expects.  Backbone, on the other hand, passes around <code>this</code> as an additional parameter throughout its event system.  Arrow functions should work fine with the framework and probably make Backbone code more concise:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.collection.on(<span class="string">'add'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.render();</div><div class="line">&#125;, <span class="keyword">this</span>);</div><div class="line"></div><div class="line"><span class="comment">// from this ^^ to this:</span></div><div class="line"></div><div class="line">myCollection.on(<span class="string">'add'</span>, () =&gt; &#123;</div><div class="line">  <span class="keyword">this</span>.render();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Note that arrow functions can be invoked through <code>.call</code> and <code>.apply</code> but we can not pass in <code>this</code> as an argument, only regular variables.  Also, arrow functions do not have their own <code>arguments</code> object.  Rest parameters still work though.  For other quirks and features of arrow functions, see the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="external">MDN reference</a>.</p>
<h2 id="conclusion"><a href="#conclusion" class="headerlink" title="conclusion"></a>conclusion</h2><p>I don’t think I’ve ever heard someone say something nice about legacy JavaScript’s specification for <code>this</code> binding.  I personally find the behavior counterintuitive but workable.  ES5’s notion of the keyword has its own logic and we must know it backward and forward.  But going forward, the ES6 arrow function gives us another tool, one that delivers a little logical and syntactic sugar for our event-driven, async code.</p>

        
      </div>
    </div>

  






          <div class="main-footer">

</div>

      
        </div>
      
    </div>
  </div>
  <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

  <link rel="stylesheet" href="/PhotoSwipe/photoswipe.css">
  <link rel="stylesheet" href="/PhotoSwipe/default-skin/default-skin.css">

  <!-- Root element of PhotoSwipe. Must have class pswp. -->
  <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
             It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

      <!-- Container that holds slides.
                PhotoSwipe keeps only 3 of them in the DOM to save memory.
                Don't modify these 3 pswp__item elements, data is added later on. -->
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>

      <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
      <div class="pswp__ui pswp__ui--hidden">

        <div class="pswp__top-bar">

          <!--  Controls are self-explanatory. Order can be changed. -->

          <div class="pswp__counter"></div>

          <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

          <button class="pswp__button pswp__button--share" title="Share"></button>

          <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

          <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

          <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
          <!-- element will get class pswp__preloader--active when preloader is running -->
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
          <div class="pswp__share-tooltip"></div>
        </div>

        <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

        <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/PhotoSwipe/photoswipe.js"></script>
  <script src="/PhotoSwipe/photoswipe-ui-default.js"></script>


<script src="/perfect-scrollbar/js/min/perfect-scrollbar.min.js"></script>
<script src="/scripts/main.js"></script>

</body>
</html>
